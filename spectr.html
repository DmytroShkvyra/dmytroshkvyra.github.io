<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
	<title>TODO supply a title</title>
	<meta charset="windows-1251">
	<meta name="viewport" content="width=device-width">
	<script data-turbolinks-track="true" src="/js/usermedia.js"></script>
	<style>
	    body {
		background-color: #141722;
		text-align: center;
		margin: 0 auto;
		position: relative;
	    }
	    .float {
		position: absolute;
		left: 0;
		top: 0;
	    }

	    .top-container {
		color: #fff;
		font-family: sans-serif;
		width: 100%;
		padding-top: 40px;
		padding-bottom: 40px;
		margin: 0 auto;
		text-align: center;
		margin-bottom: 40px;
		border-bottom: 2px solid rgba(0, 0, 0, 1);
		background-color: rgba(128, 128, 128, 0.16);
	    }

	    .top-container h1 {
		font-size: 28px;
	    }

	    .top-container h2 {
		font-size: 14px;
		font-weight: 100;
		opacity: 0.6;
	    }

	    #canvas {
		border: 2px solid black;
		background-color: rgba(128, 128, 128, 0.16);
	    }

	    input:disabled {
		opacity: 0.1;
	    }
	</style>
	<script>
/*
  Read my blog post about Web Audio API:
  http://codepen.io/DonKarlssonSan/blog/fun-with-web-audio-api

  Browser support for Web Audio API:
  http://caniuse.com/#feat=audio-api
*/
{
  var AudioContext = window.AudioContext ||
      window.webkitAudioContext;
  var audioContext;
  var biquadFilter;
  
  var frequencySlider;
  var qSlider;
  var gainSlider;
  var audio;
    var userMedia = new UserMedia();
    userMedia.getUserMedia('audio', 'input', success, alert, undefined);
    function success(stream){
	audio = stream;
    }
 
  
  // All Web Audio API filters
  // https://developer.mozilla.org/en-US/docs/Web/API/BiquadFilterNode/type
  // q and gain controls if the corresponding slider
  // should be enabled
  var filters = { "lowpass": {
      q: true,
      gain: false
    }, "highpass": {
      q: true,
      gain: false 
    }, "bandpass": {
      q: true,
      gain: false 
    }, "lowshelf": { 
      q: false,
      gain: true 
    }, "highshelf": { 
      q: false,
      gain: true 
    }, "peaking": { 
      q: true,
      gain: true 
    }, "notch": { 
      q: true,
      gain: false 
    }, "allpass": { 
      q: true,
      gain: false 
    } 
  };
  
  var canvas;
  var canvasContext;
  
  var analyser;

  var frequencyBars = 100;
  // Array containing all the frequencies we want to get
  // response for when calling getFrequencyResponse()
  var myFrequencyArray = new Float32Array(frequencyBars);
  for(var i = 0; i < frequencyBars; ++i) {
    myFrequencyArray[i] = 2000/frequencyBars*(i+1);
  }
  
  // We receive the result in these two when calling
  // getFrequencyResponse()
  var magResponseOutput = new Float32Array(frequencyBars); // magnitude
  var phaseResponseOutput = new Float32Array(frequencyBars);  
  
  audioContext = new AudioContext();
  
    biquadFilter = audioContext.createBiquadFilter();
    biquadFilter.type = "lowpass";
    biquadFilter.frequency.value = 1000;
    biquadFilter.Q.value = 10;
    biquadFilter.gain.value = 20;
    
    analyser = audioContext.createAnalyser();


  function load(e) {
  frequencySlider = document.getElementById("frequencySlider");
  qSlider = document.getElementById("qSlider");
  gainSlider = document.getElementById("gainSlider");      
      
   frequencySlider.addEventListener("change", function () {
    biquadFilter.frequency.value = this.value; 
  });
  
  frequencySlider.addEventListener("mousemove", function () {
    biquadFilter.frequency.value = this.value;
    updateFrequencyResponse();
  });

  qSlider.addEventListener("mousemove", function () {
    biquadFilter.Q.value = this.value; 
    updateFrequencyResponse();
  });

  gainSlider.addEventListener("mousemove", function () {
    biquadFilter.gain.value = this.value;
    updateFrequencyResponse();
  });     
    canvas = document.getElementById("canvas");
    canvasContext = canvas.getContext("2d");
  
    audio = document.getElementById("theSong");   
    audio.crossOrigin = "anonymous";

    var source = audioContext.createMediaStreamSource(audio);
    
    biquadFilter = audioContext.createBiquadFilter();
    biquadFilter.type = "lowpass";
    biquadFilter.frequency.value = 1000;
    biquadFilter.Q.value = 10;
    biquadFilter.gain.value = 20;

    source.connect(biquadFilter);
    biquadFilter.connect(analyser);
    
    analyser.fftSize = 32;
    analyser.connect(audioContext.destination);
 
 
  var filtersDropdown = document.getElementById("filtersDropdown");    

  for(var item in filters) {
    var option = document.createElement("option");
    option.innerHTML = item;
    // This will cause a re-flow of the page but we don't care
    filtersDropdown.appendChild(option);
  };

  function filterClicked (event) {
    event = event || window.event;
    var target = event.target || event.srcElement;
    var filterName = target.value;
    biquadFilter.type = filterName;
    updateFrequencyResponse();
    qSlider.disabled = !filters[filterName].q;
    gainSlider.disabled = !filters[filterName].gain;
  };
  filtersDropdown.addEventListener("change", filterClicked, false);	
	
	
    frequencyData = new Uint8Array(analyser.frequencyBinCount);
//    audio.pause();
//    audio.play();
    renderFrame();    

    updateFrequencyResponse();
  };

function renderFrame() {
    analyser.getByteFrequencyData(frequencyData);
    P10.style.height = ((frequencyData[0] * 100) / 256) + "%";
    P20.style.height = ((frequencyData[1] * 100) / 256) + "%";
    P30.style.height = ((frequencyData[2] * 100) / 256) + "%";
    P40.style.height = ((frequencyData[3] * 100) / 256) + "%";
    P50.style.height = ((frequencyData[4] * 100) / 256) + "%";
    P60.style.height = ((frequencyData[5] * 100) / 256) + "%";
    P70.style.height = ((frequencyData[6] * 100) / 256) + "%";
    P80.style.height = ((frequencyData[7] * 100) / 256) + "%";
    P90.style.height = ((frequencyData[8] * 100) / 256) + "%";
    console.log(frequencyData);
    requestAnimationFrame(renderFrame);
}

  function drawFrequencyResponse(mag, phase) {
    canvasContext.clearRect(0, 0, canvas.width, canvas.height);
    var barWidth = 400 / frequencyBars;
    
    // Magnitude
    canvasContext.strokeStyle = "white";
    canvasContext.beginPath();
    for(var frequencyStep = 0; frequencyStep < frequencyBars; ++frequencyStep) {
      canvasContext.lineTo(
        frequencyStep * barWidth, 
        canvas.height - mag[frequencyStep]*90);
    }
    canvasContext.stroke();
    
    // Phase
    canvasContext.strokeStyle = "red";
    canvasContext.beginPath();
    for(var frequencyStep = 0; frequencyStep < frequencyBars; ++frequencyStep) {
      canvasContext.lineTo(
        frequencyStep * barWidth, 
        canvas.height - (phase[frequencyStep]*90 + 300)/Math.PI);
    }
    canvasContext.stroke();
  } 
  
  function updateFrequencyResponse() {
    biquadFilter.getFrequencyResponse(
      myFrequencyArray, 
      magResponseOutput,
      phaseResponseOutput);
    drawFrequencyResponse(magResponseOutput, phaseResponseOutput);
  }

  



};

	</script>	

    </head>
    <body onload="load();">
<div class="top-container">
	<div id="bar">
	    <div id="P10" class="p"></div>
	    <div id="P20" class="p"></div>
	    <div id="P30" class="p"></div>
	    <div id="P40" class="p"></div>
	    <div id="P50" class="p"></div>
	    <div id="P60" class="p"></div>
	    <div id="P70" class="p"></div>
	    <div id="P80" class="p"></div>
	    <div id="P90" class="p"></div>
	</div>
</div>

<div id="controls">
  <p>
    <select id="filtersDropdown">
    </select>
  </p>
  <canvas id="canvas" width="400" height ="200"></canvas>
  <p>
    <input id="frequencySlider" title="Frequency" type="range" min="0" max="2000" value="1000" />
    <input id="qSlider" title="Q" type="range" min="1" max="100" value="10" />
    <input id="gainSlider" title="Gain" disabled type="range" min="1" max="100" value="20" />
  </p>
</div>
    </body>
</html>
