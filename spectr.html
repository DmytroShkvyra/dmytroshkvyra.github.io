<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
	<title>TODO supply a title</title>
	<meta charset="windows-1251">
	<meta name="viewport" content="width=device-width">
	<script data-turbolinks-track="true" src="/js/usermedia.js"></script>
	<style>
	    #bar {
		position: fixed;
		top: 20%;
		left: 40%;
		width: 40%;
		height: 40%;
		-webkit-transition: 0.1s ease all;
	    }

	    .p {
		background-color: blue;
		height: 100%;
		width: 10%;
		float: left;
	    }

	</style>
	<script>    
/*function gotStream(stream) {
    inputPoint = audioContext.createGain();

    // Create an AudioNode from the stream.
    realAudioInput = audioContext.createMediaStreamSource(stream);
    audioInput = realAudioInput;
    audioInput.connect(inputPoint);

//    audioInput = convertToMono( input );

    analyserNode = audioContext.createAnalyser();
    analyserNode.fftSize = 2048;
    inputPoint.connect( analyserNode );

    audioRecorder = new Recorder( inputPoint );

    zeroGain = audioContext.createGain();
    zeroGain.gain.value = 0.0;
    inputPoint.connect( zeroGain );
    zeroGain.connect( audioContext.destination );
    updateAnalysers();
}*/

var userMedia = new UserMedia();
var frequencyData;
var analyser;
var biquadFilter;

var frequencySlider = document.getElementById("frequencySlider");
var qSlider = document.getElementById("qSlider");
var gainSlider = document.getElementById("gainSlider");
var filters = { "lowpass": {
      q: true,
      gain: false
    }, "highpass": {
      q: true,
      gain: false 
    }, "bandpass": {
      q: true,
      gain: false 
    }, "lowshelf": { 
      q: false,
      gain: true 
    }, "highshelf": { 
      q: false,
      gain: true 
    }, "peaking": { 
      q: true,
      gain: true 
    }, "notch": { 
      q: true,
      gain: false 
    }, "allpass": { 
      q: true,
      gain: false 
    } 
  };

  var frequencyBars = 32;
  // Array containing all the frequencies we want to get
  // response for when calling getFrequencyResponse()
  var myFrequencyArray = new Float32Array(frequencyBars);

  
  // We receive the result in these two when calling
  // getFrequencyResponse()
  var magResponseOutput = new Float32Array(frequencyBars); // magnitude
  var phaseResponseOutput = new Float32Array(frequencyBars); 


function startAnaliz(stream){
    audioCtx = new AudioContext();
    
  for(var i = 0; i < frequencyBars; ++i) {
    myFrequencyArray[i] = ((frequencyBars - 1) * audioCtx.samplerate/frequencyBars|0)/frequencyBars*(i+1);
  } 
  
  biquadFilter = audioCtx.createBiquadFilter();
  biquadFilter.type = "lowpass";
  biquadFilter.frequency.value = 1000;
  biquadFilter.Q.value = 10;
  biquadFilter.gain.value = 20;
  
    // We receive the result in these two when calling
  // getFrequencyResponse()
  var magResponseOutput = new Float32Array(frequencyBars); // magnitude
  var phaseResponseOutput = new Float32Array(frequencyBars);  
  
    analyser = audioCtx.createAnalyser();
    source = audioCtx.createMediaStreamSource(stream);
    source.connect(biquadFilter);
    biquadFilter.connect(analyser);
    //analyser.connect(audioCtx.destination);
    analyser.fftSize = frequencyBars;

    frequencyData = new Uint8Array(analyser.frequencyBinCount);
//    audio.pause();
//    audio.play();
    renderFrame();
}

function renderFrame() {
    analyser.getByteFrequencyData(frequencyData);
    P10.style.height = ((frequencyData[0] * 100) / 256) + "%";
    P20.style.height = ((frequencyData[1] * 100) / 256) + "%";
    P30.style.height = ((frequencyData[2] * 100) / 256) + "%";
    P40.style.height = ((frequencyData[3] * 100) / 256) + "%";
    P50.style.height = ((frequencyData[4] * 100) / 256) + "%";
    P60.style.height = ((frequencyData[5] * 100) / 256) + "%";
    P70.style.height = ((frequencyData[6] * 100) / 256) + "%";
    P80.style.height = ((frequencyData[7] * 100) / 256) + "%";
    P90.style.height = ((frequencyData[8] * 100) / 256) + "%";
    P10.value= 'Hz';
    console.log(frequencyData);
    requestAnimationFrame(renderFrame);
}
		
window.onload = function() {
    userMedia.getUserMedia('audio', 'input', startAnaliz, alert, undefined);
};
	</script>	

    </head>
    <body>
	<div id="bar">
	    <div id="P10" class="p"></div>
	    <div id="P20" class="p"></div>
	    <div id="P30" class="p"></div>
	    <div id="P40" class="p"></div>
	    <div id="P50" class="p"></div>
	    <div id="P60" class="p"></div>
	    <div id="P70" class="p"></div>
	    <div id="P80" class="p"></div>
	    <div id="P90" class="p"></div>
	</div>
	<div>
<input id="frequencySlider" title="Frequency" type="range" min="0" max="2000" value="1000" />
    <input id="qSlider" title="Q" type="range" min="1" max="100" value="10" />
    <input id="gainSlider" title="Gain" disabled type="range" min="1" max="100" value="20" />	    
	</div>
    </body>
</html>
