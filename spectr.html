<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
	<title>TODO supply a title</title>
	<meta charset="windows-1251">
	<meta name="viewport" content="width=device-width">
	<script data-turbolinks-track="true" src="/js/usermedia.js"></script>
	<style>
	    #bar {
		position: fixed;
		top: 20%;
		left: 40%;
		width: 40%;
		height: 40%;
		-webkit-transition: 0.1s ease all;
	    }

	    .p {
		background-color: blue;
		height: 100%;
		width: 10%;
		float: left;
	    }

	</style>
	<script>    
/*function gotStream(stream) {
    inputPoint = audioContext.createGain();

    // Create an AudioNode from the stream.
    realAudioInput = audioContext.createMediaStreamSource(stream);
    audioInput = realAudioInput;
    audioInput.connect(inputPoint);

//    audioInput = convertToMono( input );

    analyserNode = audioContext.createAnalyser();
    analyserNode.fftSize = 2048;
    inputPoint.connect( analyserNode );

    audioRecorder = new Recorder( inputPoint );

    zeroGain = audioContext.createGain();
    zeroGain.gain.value = 0.0;
    inputPoint.connect( zeroGain );
    zeroGain.connect( audioContext.destination );
    updateAnalysers();
}*/

var userMedia = new UserMedia();
var frequencyData;
var analyser;

function startAnaliz(stream){
    audioCtx = new AudioContext();
    analyser = audioCtx.createAnalyser();
    source = audioCtx.createMediaStreamSource(stream);
    source.connect(analyser);
    //analyser.connect(audioCtx.destination);
    analyser.fftSize = 32;

    frequencyData = new Uint8Array(analyser.frequencyBinCount);
//    audio.pause();
//    audio.play();
    renderFrame();
}

function renderFrame() {
    analyser.getByteFrequencyData(frequencyData);
    P10.style.height = ((frequencyData[0] * 100) / 256) + "%";
    P20.style.height = ((frequencyData[1] * 100) / 256) + "%";
    P30.style.height = ((frequencyData[2] * 100) / 256) + "%";
    P40.style.height = ((frequencyData[3] * 100) / 256) + "%";
    P50.style.height = ((frequencyData[4] * 100) / 256) + "%";
    P60.style.height = ((frequencyData[5] * 100) / 256) + "%";
    P70.style.height = ((frequencyData[6] * 100) / 256) + "%";
    P80.style.height = ((frequencyData[7] * 100) / 256) + "%";
    P90.style.height = ((frequencyData[8] * 100) / 256) + "%";
    P10.value= 'Hz';
    console.log(frequencyData);
    requestAnimationFrame(renderFrame);
}
		
window.onload = function() {
    userMedia.getUserMedia('audio', 'input', startAnaliz, alert, undefined);
};
	</script>	

    </head>
    <body>
	<audio id="audio"></audio>
	<div id="bar">
	    <div id="P10" class="p"></div>
	    <div id="P20" class="p"></div>
	    <div id="P30" class="p"></div>
	    <div id="P40" class="p"></div>
	    <div id="P50" class="p"></div>
	    <div id="P60" class="p"></div>
	    <div id="P70" class="p"></div>
	    <div id="P80" class="p"></div>
	    <div id="P90" class="p"></div>
	</div>
    </body>
</html>
